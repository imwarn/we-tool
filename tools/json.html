<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="JSON æ ¼å¼åŒ–å·¥å…· - æ ¼å¼åŒ–ã€å‹ç¼©ã€éªŒè¯ã€ç¾åŒ– JSON æ•°æ®">
    <meta name="keywords" content="JSONæ ¼å¼åŒ–,JSONéªŒè¯,JSONå‹ç¼©,JSONç¾åŒ–,JSONå·¥å…·">
    <title>JSON æ ¼å¼åŒ– - å¼€å‘è€…å·¥å…·ç®±</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“‹</text></svg>">
    
    <!-- å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/tool.css">
    
    <style>
        .json-editor {
            position: relative;
        }

        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 50px;
            padding: 12px 5px;
            background: #f5f5f5;
            border-right: 2px solid var(--color-secondary);
            color: #999;
            text-align: right;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            user-select: none;
            border-radius: 10px 0 0 10px;
            overflow: hidden;
        }

        .json-textarea {
            padding-left: 60px !important;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .error-message {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-left: 4px solid var(--color-error);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .error-title {
            color: var(--color-error);
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-detail {
            color: var(--color-paragraph);
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            white-space: pre-wrap;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 4px solid var(--color-success);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .success-title {
            color: var(--color-success);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* æ ‘å½¢è§†å›¾æ ·å¼ */
        .json-tree {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.8;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .json-tree-node {
            margin-left: 20px;
        }

        .json-tree-line {
            display: flex;
            align-items: flex-start;
            margin: 2px 0;
        }

        .json-tree-toggle {
            cursor: pointer;
            user-select: none;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            color: #888;
            transition: all 0.2s;
        }

        .json-tree-toggle:hover {
            color: #ffd803;
            transform: scale(1.2);
        }

        .json-tree-toggle.collapsed::before {
            content: 'â–¶';
        }

        .json-tree-toggle.expanded::before {
            content: 'â–¼';
        }

        .json-tree-toggle.empty {
            visibility: hidden;
        }

        .json-tree-content {
            flex: 1;
        }

        .json-tree-children {
            margin-left: 15px;
            border-left: 1px dashed #555;
            padding-left: 10px;
        }

        .json-tree-children.collapsed {
            display: none;
        }

        .json-key {
            color: #66d9ef;
            font-weight: 600;
        }

        .json-string {
            color: #a6e22e;
        }

        .json-number {
            color: #ae81ff;
        }

        .json-boolean {
            color: #fd971f;
        }

        .json-null {
            color: #f92672;
        }

        .json-bracket {
            color: #f8f8f2;
            font-weight: bold;
        }

        .json-count {
            color: #888;
            font-size: 0.85em;
            margin-left: 8px;
        }

        .json-copy-btn {
            color: #888;
            cursor: pointer;
            margin-left: 10px;
            opacity: 0;
            transition: all 0.2s;
        }

        .json-tree-line:hover .json-copy-btn {
            opacity: 1;
        }

        .json-copy-btn:hover {
            color: #ffd803;
        }

        .indent-control {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .indent-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid var(--color-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .indent-btn.active {
            background: var(--color-button);
            border-color: var(--color-button);
            color: var(--color-button-text);
        }

        .tree-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tree-control-btn {
            padding: 6px 12px;
            background: #3d3d3d;
            color: #f8f8f2;
            border: 1px solid #555;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .tree-control-btn:hover {
            background: #4d4d4d;
            border-color: #ffd803;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">
                <div class="logo-icon">ğŸ› ï¸</div>
                <span data-i18n="nav.home">å¼€å‘è€…å·¥å…·ç®±</span>
            </a>
            <a href="../index.html" class="back-btn">
                <span>â†</span>
                <span data-i18n="common.back">è¿”å›é¦–é¡µ</span>
            </a>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">ğŸ“‹ JSON æ ¼å¼åŒ–</h1>
            <p class="page-subtitle">æ ¼å¼åŒ–ã€å‹ç¼©ã€éªŒè¯ã€ç¾åŒ– JSON æ•°æ®</p>
        </div>

        <!-- æ“ä½œé¢æ¿ -->
        <div class="tool-panel">
            <h2 class="section-title">JSON ç¼–è¾‘å™¨</h2>

            <div class="indent-control">
                <label style="font-weight: 600;">ç¼©è¿›ç©ºæ ¼ï¼š</label>
                <button class="indent-btn" onclick="setIndent(2)">2</button>
                <button class="indent-btn active" onclick="setIndent(4)">4</button>
                <button class="indent-btn" onclick="setIndent(8)">8</button>
                <label style="margin-left: 20px;">
                    <input type="checkbox" id="sortKeys">
                    <span style="margin-left: 5px;">æ’åºé”®å</span>
                </label>
            </div>

            <div class="form-group">
                <label class="form-label">è¾“å…¥ JSON</label>
                <div class="json-editor">
                    <div class="line-numbers" id="lineNumbers">1</div>
                    <textarea 
                        class="form-textarea json-textarea" 
                        id="jsonInput" 
                        placeholder='è¾“å…¥æˆ–ç²˜è´´ JSON æ•°æ®ï¼Œä¾‹å¦‚ï¼š{"name": "å¼ ä¸‰", "age": 25}'
                        style="min-height: 300px;"
                    ></textarea>
                </div>
            </div>

            <div class="error-message" id="errorMessage">
                <div class="error-title">
                    <span>âŒ</span>
                    <span>JSON æ ¼å¼é”™è¯¯</span>
                </div>
                <div class="error-detail" id="errorDetail"></div>
            </div>

            <div class="success-message" id="successMessage">
                <div class="success-title">
                    <span>âœ“</span>
                    <span>JSON æ ¼å¼æ­£ç¡®</span>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="formatJSON()">
                    <span>âœ¨</span>
                    <span>æ ¼å¼åŒ–</span>
                </button>
                <button class="btn btn-success" onclick="compressJSON()">
                    <span>ğŸ“¦</span>
                    <span>å‹ç¼©</span>
                </button>
                <button class="btn btn-success" onclick="validateJSON()">
                    <span>âœ“</span>
                    <span>éªŒè¯</span>
                </button>
                <button class="btn btn-secondary" onclick="copyJSON()">
                    <span>ğŸ“‹</span>
                    <span>å¤åˆ¶</span>
                </button>
                <button class="btn btn-secondary" onclick="clearJSON()">
                    <span>ğŸ—‘ï¸</span>
                    <span>æ¸…ç©º</span>
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="jsonSize">0 B</div>
                    <div class="stat-label">æ•°æ®å¤§å°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="jsonLines">0</div>
                    <div class="stat-label">è¡Œæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="jsonDepth">0</div>
                    <div class="stat-label">åµŒå¥—æ·±åº¦</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="jsonKeys">0</div>
                    <div class="stat-label">é”®æ•°é‡</div>
                </div>
            </div>
        </div>

        <!-- å¯è§†åŒ–æ ‘å½¢ç»“æ„ -->
        <div class="tool-panel">
            <h2 class="section-title">æ ‘å½¢è§†å›¾</h2>
            
            <div class="tree-controls">
                <button class="tree-control-btn" onclick="expandAll()">
                    <span>ğŸ“‚</span> å…¨éƒ¨å±•å¼€
                </button>
                <button class="tree-control-btn" onclick="collapseAll()">
                    <span>ğŸ“</span> å…¨éƒ¨æŠ˜å 
                </button>
                <button class="tree-control-btn" onclick="expandLevel(1)">
                    å±•å¼€ 1 å±‚
                </button>
                <button class="tree-control-btn" onclick="expandLevel(2)">
                    å±•å¼€ 2 å±‚
                </button>
                <button class="tree-control-btn" onclick="expandLevel(3)">
                    å±•å¼€ 3 å±‚
                </button>
            </div>

            <div class="json-tree" id="jsonTree">
                <div style="opacity: 0.5; text-align: center; padding: 40px;">
                    è¾“å…¥ JSON æ•°æ®åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºæ ‘å½¢ç»“æ„
                </div>
            </div>
        </div>

        <!-- ç¤ºä¾‹ JSON -->
        <div class="tool-panel">
            <h2 class="section-title">ç¤ºä¾‹ JSON</h2>
            <div class="grid-3">
                <button class="btn btn-secondary" onclick="loadExample('simple')">
                    <span>ğŸ“</span>
                    <span>ç®€å•å¯¹è±¡</span>
                </button>
                <button class="btn btn-secondary" onclick="loadExample('array')">
                    <span>ğŸ“š</span>
                    <span>æ•°ç»„æ•°æ®</span>
                </button>
                <button class="btn btn-secondary" onclick="loadExample('nested')">
                    <span>ğŸ—ï¸</span>
                    <span>åµŒå¥—ç»“æ„</span>
                </button>
                <button class="btn btn-secondary" onclick="loadExample('api')">
                    <span>ğŸŒ</span>
                    <span>API å“åº”</span>
                </button>
                <button class="btn btn-secondary" onclick="loadExample('config')">
                    <span>âš™ï¸</span>
                    <span>é…ç½®æ–‡ä»¶</span>
                </button>
                <button class="btn btn-secondary" onclick="loadExample('complex')">
                    <span>ğŸ¯</span>
                    <span>å¤æ‚æ•°æ®</span>
                </button>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="info-box">
            <h4>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
            <ul>
                <li><strong>æ ¼å¼åŒ–</strong>ï¼šç¾åŒ– JSONï¼Œä½¿å…¶æ˜“äºé˜…è¯»</li>
                <li><strong>å‹ç¼©</strong>ï¼šç§»é™¤ç©ºæ ¼å’Œæ¢è¡Œï¼Œå‡å°æ–‡ä»¶å¤§å°</li>
                <li><strong>éªŒè¯</strong>ï¼šæ£€æŸ¥ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®</li>
                <li><strong>æ ‘å½¢è§†å›¾</strong>ï¼šå¯æŠ˜å çš„æ ‘å½¢ç»“æ„ï¼Œç‚¹å‡» â–¶/â–¼ å±•å¼€/æŠ˜å </li>
                <li><strong>å¿«é€Ÿå¤åˆ¶</strong>ï¼šé¼ æ ‡æ‚¬åœåœ¨æ ‘å½¢èŠ‚ç‚¹ä¸Šï¼Œç‚¹å‡» ğŸ“‹ å¤åˆ¶è¯¥å€¼</li>
                <li><strong>å¿«æ·é”®</strong>ï¼šCtrl+Enter æ ¼å¼åŒ–ï¼ŒCtrl+Shift+C å‹ç¼©</li>
            </ul>
        </div>

        <div class="info-box warning">
            <h4>âš ï¸ å¸¸è§é”™è¯¯</h4>
            <ul>
                <li><strong>ç¼ºå°‘å¼•å·</strong>ï¼šé”®åå¿…é¡»ç”¨åŒå¼•å·åŒ…è£¹ï¼Œå¦‚ "name"</li>
                <li><strong>å¤šä½™é€—å·</strong>ï¼šæ•°ç»„æˆ–å¯¹è±¡æœ€åä¸€é¡¹åä¸èƒ½æœ‰é€—å·</li>
                <li><strong>å•å¼•å·</strong>ï¼šJSON æ ‡å‡†åªæ”¯æŒåŒå¼•å·ï¼Œä¸æ”¯æŒå•å¼•å·</li>
                <li><strong>æ³¨é‡Š</strong>ï¼šæ ‡å‡† JSON ä¸æ”¯æŒæ³¨é‡Š</li>
                <li><strong>ç‰¹æ®Šå­—ç¬¦</strong>ï¼šéœ€è¦è½¬ä¹‰ï¼Œå¦‚ \n \t \"</li>
            </ul>
        </div>
    </div>

    <!-- å…¬å…±è„šæœ¬ -->
    <script src="../assets/js/common.js"></script>

    <script>
        let currentIndent = 4;
        let jsonData = null;

        // ç¤ºä¾‹æ•°æ®
        const examples = {
            simple: {
                name: "å¼ ä¸‰",
                age: 25,
                city: "åŒ—äº¬",
                active: true
            },
            array: {
                users: [
                    { id: 1, name: "å¼ ä¸‰", email: "zhang@example.com" },
                    { id: 2, name: "æå››", email: "li@example.com" },
                    { id: 3, name: "ç‹äº”", email: "wang@example.com" }
                ]
            },
            nested: {
                company: {
                    name: "ç§‘æŠ€å…¬å¸",
                    address: {
                        country: "ä¸­å›½",
                        city: "åŒ—äº¬",
                        street: "ä¸­å…³æ‘å¤§è¡—1å·"
                    },
                    departments: [
                        {
                            name: "æŠ€æœ¯éƒ¨",
                            employees: 50
                        },
                        {
                            name: "å¸‚åœºéƒ¨",
                            employees: 30
                        }
                    ]
                }
            },
            api: {
                code: 200,
                message: "success",
                data: {
                    total: 100,
                    page: 1,
                    pageSize: 10,
                    items: [
                        { id: 1, title: "ç¤ºä¾‹1" },
                        { id: 2, title: "ç¤ºä¾‹2" }
                    ]
                },
                timestamp: 1234567890
            },
            config: {
                server: {
                    host: "localhost",
                    port: 3000,
                    ssl: false
                },
                database: {
                    type: "mongodb",
                    url: "mongodb://localhost:27017",
                    name: "mydb"
                },
                cache: {
                    enabled: true,
                    ttl: 3600
                }
            },
            complex: {
                version: "1.0.0",
                metadata: {
                    author: "å¼€å‘è€…",
                    created: "2024-01-01",
                    tags: ["json", "tool", "formatter"]
                },
                features: [
                    {
                        name: "æ ¼å¼åŒ–",
                        enabled: true,
                        options: {
                            indent: 4,
                            sortKeys: false
                        }
                    },
                    {
                        name: "å‹ç¼©",
                        enabled: true,
                        options: null
                    }
                ],
                settings: {
                    theme: "dark",
                    fontSize: 14,
                    autoSave: true,
                    shortcuts: {
                        format: "Ctrl+Enter",
                        compress: "Ctrl+Shift+C"
                    }
                }
            }
        };

        // æ›´æ–°è¡Œå·
        function updateLineNumbers() {
            const textarea = document.getElementById('jsonInput');
            const lines = textarea.value.split('\n').length;
            const lineNumbers = document.getElementById('lineNumbers');
            lineNumbers.innerHTML = Array.from({ length: lines }, (_, i) => i + 1).join('\n');
        }

        // è¾“å…¥ç›‘å¬
        document.getElementById('jsonInput').addEventListener('input', function() {
            updateLineNumbers();
            updateStats();
        });

        document.getElementById('jsonInput').addEventListener('scroll', function() {
            document.getElementById('lineNumbers').scrollTop = this.scrollTop;
        });

        // å¿«æ·é”®
        document.getElementById('jsonInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                formatJSON();
            } else if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                compressJSON();
            }
        });

        // è®¾ç½®ç¼©è¿›
        function setIndent(spaces) {
            currentIndent = spaces;
            document.querySelectorAll('.indent-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // æ ¼å¼åŒ– JSON
        function formatJSON() {
            const input = document.getElementById('jsonInput').value.trim();
            
            if (!input) {
                DevToolkit.Toast.warning('è¯·è¾“å…¥ JSON æ•°æ®');
                return;
            }

            try {
                jsonData = JSON.parse(input);
                const sortKeys = document.getElementById('sortKeys').checked;
                
                let formatted;
                if (sortKeys) {
                    formatted = JSON.stringify(sortObject(jsonData), null, currentIndent);
                } else {
                    formatted = JSON.stringify(jsonData, null, currentIndent);
                }
                
                document.getElementById('jsonInput').value = formatted;
                updateLineNumbers();
                updateStats();
                updateTreeView(jsonData);
                showSuccess();
                DevToolkit.Toast.success('æ ¼å¼åŒ–æˆåŠŸï¼');
            } catch (e) {
                showError(e);
            }
        }

        // å‹ç¼© JSON
        function compressJSON() {
            const input = document.getElementById('jsonInput').value.trim();
            
            if (!input) {
                DevToolkit.Toast.warning('è¯·è¾“å…¥ JSON æ•°æ®');
                return;
            }

            try {
                jsonData = JSON.parse(input);
                const compressed = JSON.stringify(jsonData);
                document.getElementById('jsonInput').value = compressed;
                updateLineNumbers();
                updateStats();
                showSuccess();
                DevToolkit.Toast.success('å‹ç¼©æˆåŠŸï¼');
            } catch (e) {
                showError(e);
            }
        }

        // éªŒè¯ JSON
        function validateJSON() {
            const input = document.getElementById('jsonInput').value.trim();
            
            if (!input) {
                DevToolkit.Toast.warning('è¯·è¾“å…¥ JSON æ•°æ®');
                return;
            }

            try {
                jsonData = JSON.parse(input);
                updateTreeView(jsonData);
                showSuccess();
                DevToolkit.Toast.success('âœ“ JSON æ ¼å¼æ­£ç¡®ï¼');
            } catch (e) {
                showError(e);
                DevToolkit.Toast.error('JSON æ ¼å¼é”™è¯¯');
            }
        }

        // å¤åˆ¶ JSON
        function copyJSON() {
            const value = document.getElementById('jsonInput').value;
            if (!value) {
                DevToolkit.Toast.warning('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
                return;
            }
            DevToolkit.copyToClipboard(value);
        }

        // æ¸…ç©º
        function clearJSON() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('jsonTree').innerHTML = '<div style="opacity: 0.5; text-align: center; padding: 40px;">è¾“å…¥ JSON æ•°æ®åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºæ ‘å½¢ç»“æ„</div>';
            updateLineNumbers();
            updateStats();
            hideMessages();
        }

        // åŠ è½½ç¤ºä¾‹
        function loadExample(type) {
            const example = examples[type];
            document.getElementById('jsonInput').value = JSON.stringify(example, null, currentIndent);
            updateLineNumbers();
            updateStats();
            updateTreeView(example);
            hideMessages();
            DevToolkit.Toast.info('å·²åŠ è½½ç¤ºä¾‹æ•°æ®');
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const value = document.getElementById('jsonInput').value;
            const size = new Blob([value]).size;
            const lines = value.split('\n').length;
            
            document.getElementById('jsonSize').textContent = DevToolkit.formatFileSize(size);
            document.getElementById('jsonLines').textContent = lines;

            try {
                const data = JSON.parse(value);
                document.getElementById('jsonDepth').textContent = getDepth(data);
                document.getElementById('jsonKeys').textContent = countKeys(data);
            } catch (e) {
                document.getElementById('jsonDepth').textContent = '-';
                document.getElementById('jsonKeys').textContent = '-';
            }
        }

        // è®¡ç®—æ·±åº¦
        function getDepth(obj, depth = 0) {
            if (obj === null || typeof obj !== 'object') return depth;
            const depths = Object.values(obj).map(value => getDepth(value, depth + 1));
            return Math.max(depth, ...depths);
        }

        // è®¡ç®—é”®æ•°é‡
        function countKeys(obj) {
            if (obj === null || typeof obj !== 'object') return 0;
            let count = Object.keys(obj).length;
            Object.values(obj).forEach(value => {
                count += countKeys(value);
            });
            return count;
        }

        // æ’åºå¯¹è±¡
        function sortObject(obj) {
            if (Array.isArray(obj)) {
                return obj.map(sortObject);
            } else if (obj !== null && typeof obj === 'object') {
                return Object.keys(obj).sort().reduce((result, key) => {
                    result[key] = sortObject(obj[key]);
                    return result;
                }, {});
            }
            return obj;
        }

        // ========== æ ‘å½¢è§†å›¾æ ¸å¿ƒåŠŸèƒ½ ==========
        let treeNodeId = 0;

        function updateTreeView(data) {
            treeNodeId = 0;
            const tree = document.getElementById('jsonTree');
            tree.innerHTML = '';
            tree.appendChild(createTreeNode(data, 'root', null, 0));
        }

        function createTreeNode(value, key, parentPath, level) {
            const nodeId = `node-${treeNodeId++}`;
            const path = parentPath ? `${parentPath}.${key}` : key;
            
            const line = document.createElement('div');
            line.className = 'json-tree-line';
            
            // åˆ‡æ¢æŒ‰é’®
            const toggle = document.createElement('span');
            toggle.className = 'json-tree-toggle';
            
            // å†…å®¹åŒºåŸŸ
            const content = document.createElement('span');
            content.className = 'json-tree-content';
            
            if (value === null) {
                toggle.classList.add('empty');
                content.innerHTML = renderKey(key) + ': ' + renderValue(null, 'null');
            } else if (typeof value === 'object') {
                const isArray = Array.isArray(value);
                const entries = isArray ? value : Object.entries(value);
                const count = isArray ? value.length : Object.keys(value).length;
                
                if (count === 0) {
                    toggle.classList.add('empty');
                    content.innerHTML = renderKey(key) + ': ' + 
                        `<span class="json-bracket">${isArray ? '[]' : '{}'}</span>`;
                } else {
                    toggle.classList.add(level < 2 ? 'expanded' : 'collapsed');
                    toggle.dataset.nodeId = nodeId;
                    toggle.onclick = () => toggleNode(nodeId);
                    
                    const openBracket = isArray ? '[' : '{';
                    const closeBracket = isArray ? ']' : '}';
                    
                    content.innerHTML = renderKey(key) + ': ' +
                        `<span class="json-bracket">${openBracket}</span>` +
                        `<span class="json-count">${count} ${isArray ? 'items' : 'keys'}</span>`;
                    
                    // å­èŠ‚ç‚¹å®¹å™¨
                    const children = document.createElement('div');
                    children.className = 'json-tree-children';
                    children.id = nodeId;
                    children.dataset.level = level;
                    
                    if (level >= 2) {
                        children.classList.add('collapsed');
                    }
                    
                    // æ·»åŠ å­èŠ‚ç‚¹
                    if (isArray) {
                        value.forEach((item, index) => {
                            children.appendChild(createTreeNode(item, `[${index}]`, path, level + 1));
                        });
                    } else {
                        Object.entries(value).forEach(([k, v]) => {
                            children.appendChild(createTreeNode(v, k, path, level + 1));
                        });
                    }
                    
                    // æ·»åŠ å…³é—­æ‹¬å·
                    const closeLine = document.createElement('div');
                    closeLine.className = 'json-tree-line';
                    closeLine.innerHTML = `<span class="json-bracket">${closeBracket}</span>`;
                    children.appendChild(closeLine);
                    
                    line.appendChild(toggle);
                    line.appendChild(content);
                    
                    const container = document.createElement('div');
                    container.appendChild(line);
                    container.appendChild(children);
                    
                    return container;
                }
            } else {
                toggle.classList.add('empty');
                const valueType = typeof value;
                content.innerHTML = renderKey(key) + ': ' + renderValue(value, valueType);
                
                // æ·»åŠ å¤åˆ¶æŒ‰é’®
                const copyBtn = document.createElement('span');
                copyBtn.className = 'json-copy-btn';
                copyBtn.innerHTML = 'ğŸ“‹';
                copyBtn.title = 'å¤åˆ¶å€¼';
                copyBtn.onclick = () => {
                    DevToolkit.copyToClipboard(JSON.stringify(value));
                };
                content.appendChild(copyBtn);
            }
            
            line.appendChild(toggle);
            line.appendChild(content);
            
            return line;
        }

        function renderKey(key) {
            if (key === 'root') return '';
            if (key.startsWith('[')) return `<span class="json-key">${key}</span>`;
            return `<span class="json-key">"${key}"</span>`;
        }

        function renderValue(value, type) {
            if (value === null) {
                return `<span class="json-null">null</span>`;
            }
            
            switch (type) {
                case 'string':
                    return `<span class="json-string">"${escapeHtml(value)}"</span>`;
                case 'number':
                    return `<span class="json-number">${value}</span>`;
                case 'boolean':
                    return `<span class="json-boolean">${value}</span>`;
                default:
                    return String(value);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleNode(nodeId) {
            const node = document.getElementById(nodeId);
            const toggle = document.querySelector(`[data-node-id="${nodeId}"]`);
            
            if (node.classList.contains('collapsed')) {
                node.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.classList.add('expanded');
            } else {
                node.classList.add('collapsed');
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
            }
        }

        function expandAll() {
            document.querySelectorAll('.json-tree-children').forEach(node => {
                node.classList.remove('collapsed');
            });
            document.querySelectorAll('.json-tree-toggle').forEach(toggle => {
                toggle.classList.remove('collapsed');
                toggle.classList.add('expanded');
            });
            DevToolkit.Toast.success('å·²å…¨éƒ¨å±•å¼€');
        }

        function collapseAll() {
            document.querySelectorAll('.json-tree-children').forEach(node => {
                node.classList.add('collapsed');
            });
            document.querySelectorAll('.json-tree-toggle').forEach(toggle => {
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
            });
            DevToolkit.Toast.success('å·²å…¨éƒ¨æŠ˜å ');
        }

        function expandLevel(maxLevel) {
            document.querySelectorAll('.json-tree-children').forEach(node => {
                const level = parseInt(node.dataset.level);
                if (level < maxLevel) {
                    node.classList.remove('collapsed');
                    const toggle = document.querySelector(`[data-node-id="${node.id}"]`);
                    if (toggle) {
                        toggle.classList.remove('collapsed');
                        toggle.classList.add('expanded');
                    }
                } else {
                    node.classList.add('collapsed');
                    const toggle = document.querySelector(`[data-node-id="${node.id}"]`);
                    if (toggle) {
                        toggle.classList.remove('expanded');
                        toggle.classList.add('collapsed');
                    }
                }
            });
            DevToolkit.Toast.success(`å·²å±•å¼€ ${maxLevel} å±‚`);
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(error) {
            hideMessages();
            const errorMessage = document.getElementById('errorMessage');
            const errorDetail = document.getElementById('errorDetail');
            
            let detail = error.message;
            if (error.message.includes('position')) {
                const match = error.message.match(/position (\d+)/);
                if (match) {
                    const pos = parseInt(match[1]);
                    const input = document.getElementById('jsonInput').value;
                    const before = input.substring(Math.max(0, pos - 20), pos);
                    const after = input.substring(pos, Math.min(input.length, pos + 20));
                    detail += `\n\né™„è¿‘å†…å®¹ï¼š\n...${before}âŒ${after}...`;
                }
            }
            
            errorDetail.textContent = detail;
            errorMessage.classList.add('show');
        }

        // æ˜¾ç¤ºæˆåŠŸ
        function showSuccess() {
            hideMessages();
            document.getElementById('successMessage').classList.add('show');
        }

        // éšè—æ¶ˆæ¯
        function hideMessages() {
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('successMessage').classList.remove('show');
        }

        // åˆå§‹åŒ–
        updateLineNumbers();
        loadExample('simple');
    </script>
</body>
</html>